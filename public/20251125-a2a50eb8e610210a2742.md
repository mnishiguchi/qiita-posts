---
title: NervesのOTAファームウェア更新：mix uploadとupload.sh
tags:
  - Elixir
  - OTA
  - Nerves
  - firmware
private: false
updated_at: '2025-11-25T21:11:11+09:00'
id: a2a50eb8e610210a2742
organization_url_name: fukuokaex
slide: false
ignorePublish: false
---
## はじめに

[Nerves](https://github.com/nerves-project)は、組み込み[Elixir](https://github.com/elixir-lang/elixir)アプリケーションのための強力なフレームワークです。その中でも特筆すべき機能の一つが[OTA（Over The Air）でのファームウェア更新](https://www.google.com/search?q=Over+The+Air%E3%81%AB%E3%82%88%E3%82%8B%E3%83%95%E3%82%A1%E3%83%BC%E3%83%A0%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%AE%E6%9B%B4%E6%96%B0&oq=OTA%EF%BC%88Over+The+Air%EF%BC%89%E3%81%AB%E3%82%88%E3%82%8B%E3%83%95%E3%82%A1%E3%83%BC%E3%83%A0%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%AE%E6%9B%B4%E6%96%B0)です。

Nervesデバイスにファームウェアを書き込む方法は大きく2通りあります：

* `mix upload` タスクを使う方法
* `upload.sh` スクリプト（`mix firmware.gen.script`で生成）を使う方法

## `mix upload` タスク

NervesでビルドしたファームウェアをSSH経由でデバイスに送信する最もシンプルな方法が、`mix upload` タスクです。

まず、通常の流れは以下の通りです：

```bash:ターミナル
MIX_TARGET=rpi4 mix firmware
MIX_TARGET=rpi4 mix upload nerves.local
```

これで、デバイスにOTA（Over The Air）でファームウェアが転送されます。

ほとんどの場合は問題なく動作しますが、以下のようなケースで失敗することがあります：

- SSH秘密鍵にパスフレーズが設定されていて、対話的入力が求められる
- デバイスのホスト鍵が更新された（例：SDカードを焼き直したあと）

その場合、`mix upload` はSSHのパスワードや鍵確認のプロンプトに応答できないため、以下のようなエラーになります：

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/82804/7ffcddcd-4319-4c53-9dc3-8b92e2a0fc6f.png)

このような場合は、次に紹介する `upload.sh` が便利です。

## `upload.sh` スクリプト

`mix upload` に代わるもう一つの方法が、`upload.sh` スクリプトです。こちらは、`mix firmware.gen.script` コマンドで生成されるシェルスクリプトで、SSHを使ってファームウェアを送信するという点では同じですが、ターミナルでの対話が可能なため、より柔軟に動作します。

以下の点で `mix upload` よりも信頼性が高く、安心して使えます：

* SSHパスワードや秘密鍵のパスフレーズの入力に対応
* デバイスのホスト鍵が変わった場合でも柔軟に接続できる
* 任意の `.fw` ファイルやホスト名を指定可能
* 複数デバイスに使い回せるため、自動化や量産にも向いている

まず、Nervesプロジェクト内で以下を実行してスクリプトを生成します：

```bash:ターミナル
mix firmware.gen.script
```

その後、以下のように実行します：

```bash:ターミナル
./upload.sh nerves.local
```

## mixタスクの定義元

Nervesでは、 `mix firmware.*` 系のタスクは [nerves](https://github.com/nerves-project/nerves) 本体で提供されています。

https://github.com/nerves-project/nerves/tree/main/lib/mix/tasks

一方、`mix upload`や`mix firmware.gen.script`は、[ssh_subsystem_fwup](https://github.com/nerves-project/ssh_subsystem_fwup) というパッケージで提供されています。

https://github.com/nerves-project/ssh_subsystem_fwup/tree/main/lib/mix/tasks

私はいつも `upload.sh` を使う派です。`mix upload` でエラーが出るたびに焦ってしまうので……記憶力にもあまり自信がなくて😅

## おわりに

Nervesを使えば、複雑な仕組みを用意しなくても、Elixirで書いた組み込みアプリケーションをOTAで簡単に更新できます。

`mix upload` は手軽に使えますが、SSHまわりでの対話が必要な場合に躓くことがあります。そんなときは `mix firmware.gen.script` で生成される `upload.sh` を使えば、柔軟に対応できて安心です。
