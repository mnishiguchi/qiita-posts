---
title: 'AtomVM: 最新のソースコードからビルド (2025年12月)'
tags:
  - Erlang
  - Elixir
  - ESP32
  - AtomVM
  - ESP32-S3
private: false
updated_at: '2025-12-21T16:23:03+09:00'
id: d4ee6fbfa9d24378446f
organization_url_name: fukuokaex
slide: false
ignorePublish: false
---
## はじめに

[AtomVM] を最新のソースコードからビルドする手順をまとめておきたいと思います。


![piyopiyo-board-2025-12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/82804/31d01365-5ac5-45dd-a125-bee49ea93d57.png)

※ 写真はイメージです

## 対象環境

今回試したときの環境は次のとおりです。

- マイコン
  - Seeed Studio XIAO ESP32-S3（オンボード LED は GPIO 21）
- ホスト PC
  - Debian 系 Linux（LMDE7）
- 主なソフトウェア
  - Elixir 1.17（Erlang/OTP 27）
  - AtomVM 0.7.0-dev+git.6ef74599
  - Python 3.14.1
  - [ESP-IDF] v5.5
  - [esptool] 5.1.0
  - [picocom] 3.1

## 手順の全体像

やることをざっくり並べると、以下のとおりです。

1. AtomVM・ESP-IDF・esptool の準備
2. Elixir コアライブラリ生成
3. ESP32-S3 向け AtomVM をビルド
4. ESP32-S3 に AtomVM を書き込み

順に見ていきます。

## AtomVM と ESP-IDF の準備

### ホスト環境に必要なツールをインストール

まずは、AtomVM のビルドや ESP32-S3 への書き込みに必要なツールを揃えます。

```bash
# Elixir と Python は任意の方法でインストールされている前提
elixir --version
python3 --version

sudo apt install git wget flex bison gperf cmake ninja-build \
  ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
```

AtomVMで使えるツールのバージョンについては以下の資料で確認してください。

https://doc.atomvm.org/latest/release-notes.html#required-software

ESP-IDF を使うために必要なツールについては以下の資料を確認してください。

https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/get-started/linux-macos-setup.html

### AtomVM のソースコードを取得

```bash
# AtomVMのソースコードの保存場所は任意
mkdir -p $HOME/Projects/atomvm
cd $HOME/Projects/atomvm

git clone https://github.com/atomvm/AtomVM
```

以降は、`$HOME/Projects/atomvm/AtomVM` をAtomVM のソースコードのルートディレクトリとします。

### ESP-IDF（ESP32-S3 用）をインストール

執筆時点では AtomVM の公式サポートは v5.4 までなのですが、手元では v5.5 で動作を確認。

```bash
# esp-idfのソースコードの保存場所は任意
mkdir -p $HOME/esp
cd $HOME/esp

git clone --branch v5.5 --recursive https://github.com/espressif/esp-idf.git
cd esp-idf

# esp32s3 向けツール群をインストール
./install.sh esp32s3

idf.py --version
```

詳しくは公式ドキュメントを参照してください。

https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/get-started/linux-macos-setup.html

### esptool のインストール

```bash
pip install esptool
esptool version
```

詳しくは公式ドキュメントを参照してください。

https://docs.espressif.com/projects/esptool/en/latest/esp32/

私は最近は `mise` を使ってます。 

https://qiita.com/mnishiguchi/items/7edc08991d809934d85c

## Elixir コアライブラリ生成

ESP32 用の完全なイメージを作るためには、先にホスト PC 上で Generic UNIX 版 AtomVM をビルドしておく必要があります。

```bash
cd "$HOME/Projects/atomvm/AtomVM"

mkdir -p build
cd build

cmake ..
make -j"$(nproc)"

# 任意だが、atomvm コマンドをインストールしておくと便利らしい
sudo make install
which atomvm
````

ビルド完了後、次のようなファイルが生成されているはずです。

```bash
ls build/libs/esp32boot
# esp32boot.avm
# elixir_esp32boot.avm
# ...
```

詳しくは公式ドキュメントを参照してください。

https://doc.atomvm.org/main/build-instructions.html

## ESP32-S3 向け AtomVM をビルド

### ESP32 プラットフォーム用ディレクトリに移動

```bash 
cd $HOME/Projects/atomvm/AtomVM/src/platforms/esp32
```

### ESP-IDF 環境を読み込む

```bash
source $HOME/esp/esp-idf/export.sh
```

### Elixir 用パーティションテーブルを指定

Elixir 用のパーティションレイアウトを使うため、`sdkconfig.defaults` に `partitions-elixir.csv` を指定します。

```ini
CONFIG_PARTITION_TABLE_CUSTOM_FILENAME="partitions-elixir.csv"
```

これで、`boot.avm` / `main.avm` などが Elixir 向けの構成になります。

### ESP32-S3 向けにビルド

ESP-IDF は機種ごとに target 名が異なります。
AtomVM のドキュメントでは `esp32` を例にしていますが、ESP32-S3 を使う場合は `esp32s3` を指定してください。

```bash
idf.py set-target esp32s3
idf.py reconfigure
idf.py build
```

ここまでで

* ESP32-S3 向け AtomVM 本体
* Elixir / Erlang コアライブラリを含むビルド成果物
* 各種補助スクリプト（`mkimage.sh` / `flashimage.sh` など）

がそろった状態になります。

### Release イメージを生成

ESP32-S3 に書き込むための「ひとまとめのイメージ」を `mkimage.sh` で作成します。

```bash
./build/mkimage.sh --boot ../../../build/libs/esp32boot/elixir_esp32boot.avm
```

`elixir_esp32boot.avm` を取り込んだ、Elixir 対応の Release イメージが生成されます。

```bash
ls -lh build/atomvm-esp32*
# build/atomvm-esp32s3-xxxxxx.img  のようなファイルができているはず
```

## ESP32-S3 に AtomVM を書き込み

### フラッシュ全消去

```bash
esptool --chip auto --port /dev/ttyACM0 erase-flash
```

### Release イメージを書き込む

`mkimage.sh` が生成したイメージを、`flashimage.sh` でまとめて書き込みます。

```bash
./build/flashimage.sh -p /dev/ttyACM0
```

`flashimage.sh` の中では `esptool.py` が呼ばれ、
適切なオフセットに bootloader / パーティションテーブル / AtomVM 本体 / Elixir コアライブラリが書き込まれます。

ここまで終わると、XIAO ESP32-S3 上に AtomVM 本体と Elixir 標準ライブラリ入りの `boot.avm` がそろった状態になっています。

## おわりに

[AtomVM] をソースコードからビルドする手順をまとめました。

ソースコードからビルドできるようになることで、
用途にあわせた独自イメージが作成できるようになります。

:tada::tada::tada:

https://piyopiyoex.connpass.com/event/377298/

[NervesJP]: https://nerves-jp.connpass.com/
[piyopiyo.ex]: https://piyopiyoex.connpass.com/
[autoracex]: https://autoracex.connpass.com/
[IoT]: https://www.google.com/search?q=IoT%E3%81%A8%E3%81%AF
[AtomVM]: https://github.com/atomvm/AtomVM
[Elixir]: https://hexdocs.pm/elixir/introduction.html
[Nerves]: https://github.com/nerves-project
[SWEST27]: https://swest.toppers.jp/phx/
[Seeed Studio XIAO ESP32-S3]: https://wiki.seeedstudio.com/xiao_esp32s3_getting_started/
[ESP32]: https://www.google.com/search?q=ESP32%E3%81%A8%E3%81%AF
[ESP32-S3]: https://www.espressif.com/ja-jp/products/socs/esp32-s3
[AtomVM/releases]: https://github.com/atomvm/AtomVM/releases
[AtomVM/doc/getting-started]: https://doc.atomvm.org/latest/getting-started-guide.html#getting-started-on-the-esp32-platform
[Blinky]: https://github.com/atomvm/atomvm_examples/tree/master/elixir/Blinky
[Erlang]: https://www.erlang.org/doc/readme.html
[ESP-IDF]: https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/get-started/
[esptool]: https://docs.espressif.com/projects/esptool/en/latest/esp32/
[screen]: https://www.google.com/search?q=screen+linux
[minicom]: https://www.google.com/search?q=minicom+linux
[picocom]: https://www.google.com/search?q=picocom+linux
[AtomVM/releases]: https://github.com/atomvm/AtomVM/releases
[Blink]: https://github.com/atomvm/AtomVM/blob/main/examples/elixir/esp32/Blink.ex
[exatomvm]: https://github.com/atomvm/exatomvm
