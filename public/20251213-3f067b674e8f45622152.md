---
title: 'AtomVM: æœ€å° NIF ã‚’è‡ªä½œã—ã¦å‹•ã‹ã—ã¦ã¿ã‚‹'
tags:
  - Elixir
  - ESP32
  - ESP-IDF
  - AtomVM
  - NIFs
private: false
updated_at: '2026-01-04T14:56:08+09:00'
id: 3f067b674e8f45622152
organization_url_name: fukuokaex
slide: false
ignorePublish: false
---
## ã¯ã˜ã‚ã«

AtomVM ä¸Šã® Elixir ã§è‰²ã€…è©¦ãã†ã¨ã™ã‚‹ã¨ã€C ã§æ›¸ã‹ã‚ŒãŸ NIF ã‚’æ‰±ãˆã‚‹ã“ã¨ãŒå‰æã«ãªã‚‹å ´é¢ãŒã‚ã‚Šã¾ã—ãŸã€‚

ãã“ã§ä»Šå›ã¯ã€å›ºå®šã®æ•´æ•° `1234` ã‚’è¿”ã™ã ã‘ã®æœ€å° NIF ã‚’è‡ªä½œã—ã€ESP32-S3 å‘ã‘ã® AtomVM ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã«çµ„ã¿è¾¼ã‚“ã§ã€Elixir ã‹ã‚‰å‘¼ã³å‡ºã™ã¨ã“ã‚ã¾ã§ã‚’ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚

å¿˜ã‚Œãªã„ã†ã¡ã«ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¾ã™ã€‚

![piyopiyo-board-2025-12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/82804/31d01365-5ac5-45dd-a125-bee49ea93d57.png)

â€» å†™çœŸã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™

## å¯¾è±¡ç’°å¢ƒ

* ãƒã‚¤ã‚³ãƒ³
  * ESP32-S3
* ãƒ›ã‚¹ãƒˆ PC
  * Debian ç³» Linux
* ä¸»ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢
  * AtomVMï¼ˆ0.7.0-dev ç³»ï¼‰
  * ESP-IDFï¼ˆv5.5ï¼‰
  * Elixir 1.17ï¼ˆErlang/OTP 27ï¼‰
  * Python (3.10 ä»¥ä¸Š)

â€» ä»¥é™ã®æ‰‹é †ã¯ã€ŒESP-IDF ã®ç’°å¢ƒãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿ã§ `idf.py` ãŒå‹•ãã€å‰æã§ã™ã€‚
â€» Erlang / Elixir / Python ã¯ `mise` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸã€‚

## ã§ããŸã‚‚ã®

* å›ºå®šå€¤ `1234` ã‚’è¿”ã™ã ã‘ã® C è£½ NIFï¼ˆElixir å´ã§ã¯ `hello/0`ï¼‰
* NIF ã‚’ ESP-IDF ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦çµ„ã¿è¾¼ã‚“ã ã€ESP32-S3 å‘ã‘ã®ã‚«ã‚¹ã‚¿ãƒ  AtomVM ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢
* `hello/0` ã‚’å‘¼ã³å‡ºã™ã ã‘ã®æœ€å° Elixir ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

æœ€çµ‚çš„ã«ãƒ­ã‚°ã«ã¯ã“ã‚“ãªå½¢ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```text
Starting application...
NIF said: 1234
Return value: ok
```

æˆæœã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¾ã¨ã‚ã¾ã—ãŸã€‚

https://github.com/piyopiyoex/hello_atomvm_nif

## C å´

å›ºå®šå€¤ã‚’è¿”ã™ã ã‘ã®æœ€å° NIF ã§ã™ã€‚
ã“ã“ã§æŠ¼ã•ãˆã¦ãŠããŸã„ç‚¹ã¯ã€ŒNIF åã®æ–‡å­—åˆ—ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã€ã¨ã€ŒKconfig ã®è¨­å®šã§ç™»éŒ²ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ã€ã§ã™ã€‚

```c:nifs/sample_app_hello.c
#include "sample_app_hello.h"

#include <context.h>
#include <nifs.h>
#include <portnifloader.h>
#include <term.h>

#include <string.h>

// è¿½è·¡ãƒ­ã‚°ãŒæ¬²ã—ã„ã¨ãã ã‘æœ‰åŠ¹åŒ–ã™ã‚‹ï¼ˆå¿…è¦ãªã¨ãã ã‘ï¼‰
// #define ENABLE_TRACE
#include <trace.h>

// AtomVM ã¯ NIF åã‚’æ–‡å­—åˆ—ã§è§£æ±ºã™ã‚‹ã€‚
// å½¢å¼ã¯ "Elixir.ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«:é–¢æ•°/ã‚¢ãƒªãƒ†ã‚£"
static term hello_0(Context *ctx, int argc, term argv[])
{
    (void) ctx;
    (void) argc;
    (void) argv;

    // è¿”ã‚Šå€¤ã¯ term_* ç³»ã§çµ„ã¿ç«‹ã¦ã‚‹ï¼ˆä»Šå›ã¯æ•´æ•°ã®ã¿ï¼‰
    return term_from_int(1234);
}

static const struct Nif hello_0_nif = {
    .base.type = NIFFunctionType,
    .nif_ptr = hello_0
};

// NIF ã®è§£æ±ºã¯ *_get_nif ã§è¡Œã†ï¼ˆåå‰ãŒä¸€è‡´ã—ãŸã‚‰ struct Nif ã‚’è¿”ã™ï¼‰
const struct Nif *sample_app_hello_get_nif(const char *nifname)
{
    TRACE("Locating NIF %s ...\n", nifname);

    if (strcmp("Elixir.SampleApp.Hello:hello/0", nifname) == 0) {
        TRACE("Resolved NIF %s\n", nifname);
        return &hello_0_nif;
    }

    return NULL;
}

static void sample_app_hello_init(GlobalContext *global)
{
    (void) global;
}

static void sample_app_hello_destroy(GlobalContext *global)
{
    (void) global;
}

// Kconfig ã® config FOO ã¯ C å´ã§ã¯ CONFIG_FOO ã«ãªã‚‹ã€‚
// ã“ã“ãŒä¸€è‡´ã—ãªã„ã¨ç™»éŒ²ã•ã‚Œãªã„ã€‚
#ifdef CONFIG_AVM_SAMPLE_APP_HELLO_NIF_ENABLE
REGISTER_NIF_COLLECTION(
    sample_app_hello,
    sample_app_hello_init,
    sample_app_hello_destroy,
    sample_app_hello_get_nif
)
#endif
```

## Elixir å´

NIF ä»¥å¤–ã®è¦å› ã§è½ã¡ãªã„ã‚ˆã†ã«ã€Elixir å´ã¯æœ€å°é™ã«ã—ã¦åˆ‡ã‚Šåˆ†ã‘ã—ã‚„ã™ãã—ã¾ã™ã€‚

```elixir
defmodule SampleApp.Hello do
  @moduledoc """
  AtomVM ä¸Šã§ã¯ `SampleApp.Hello.hello/0` ãŒ C ã® NIF
  "Elixir.SampleApp.Hello:hello/0" ã«å·®ã—æ›¿ã‚ã‚‹æƒ³å®šã€‚
  """
  
  @spec hello() :: integer() | :nif_not_loaded
  # NIF ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ã“ã®å€¤ã®ã¾ã¾è¿”ã‚‹ã€‚
  def hello, do: :nif_not_loaded
end
```

å‘¼ã³å‡ºã—å´ã¯ã€`hello/0` ã‚’å‘¼ã¶ã ã‘ã§ã™ã€‚

```elixir
defmodule SampleApp do
  @moduledoc false

  def start, do: loop()

  defp loop do
    IO.puts("NIF said: #{inspect(SampleApp.Hello.hello())}")
    Process.sleep(1000)
    loop()
  end
end
```

## AtomVM å´

AtomVM ã® ESP32 å‘ã‘ã‚½ãƒ¼ã‚¹ï¼ˆ`src/platforms/esp32`ï¼‰ã«ã€NIF ã‚’ ESP-IDF ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚

AtomVM æœ¬ä½“ã¯å…±é€šã®å ´æ‰€ã«ç½®ãã€NIF å´ã ã‘ã‚’ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã§å·®ã—è¾¼ã‚€æ–¹é‡ã«ã—ã¾ã—ãŸã€‚

ã“ã®ã‚„ã‚Šæ–¹ã§è‰¯ã„ã®ã‹ã©ã†ã‹ã¯çŸ¥ã‚Šã¾ã›ã‚“ã€‚

```bash:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
my_atomvm_esp32_path="$HOME/Projects/atomvm/AtomVM/src/platforms/esp32"
my_nif_src="$HOME/Projects/hello_atomvm_nif"
my_nif_dest="$my_atomvm_esp32_path/components/hello_atomvm_nif"

# æ—¢å­˜ãŒã‚ã£ã¦ã‚‚ç½®ãæ›ãˆã‚‹ï¼ˆ-s: symlink, -f: force, -n: treat dest as normal fileï¼‰
ln -sfn "$my_nif_src" "$my_nif_dest"
```

ESP-IDF ã®ç’°å¢ƒã‚’èª­ã¿è¾¼ã¿ã€AtomVMï¼ˆESP32 å‘ã‘ï¼‰ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```bash:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
cd "$my_atomvm_esp32_path"
source ~/esp/esp-idf/export.sh

idf.py set-target esp32s3
idf.py build
```

â€» ESP-IDF ã‚’å…¬å¼æ‰‹é †ã§å…¥ã‚Œã¦ã„ã‚‹å ´åˆã€`~/esp/esp-idf` é…ä¸‹ã« `export.sh`ã€`export.fish` ç­‰ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

## Elixir ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹

ã¾ãšã¯ Elixir å´ã® `.avm`ï¼ˆpackbeam ã•ã‚ŒãŸæˆæœç‰©ï¼‰ã‚’ä½œã‚Šã¾ã™ã€‚

```bash:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
cd ~/Projects/hello_atomvm_nif/examples/hello_nif_elixir

mix deps.get
mix atomvm.packbeam
```

æ›¸ãè¾¼ã¿ã¯ `mix atomvm.esp32.flash` ã§ã‚‚ã§ãã¾ã™ãŒã€ç’°å¢ƒã«ã‚ˆã£ã¦ã¯ `esptool.py` ã®å®Ÿè¡Œæ¨©é™ã‚„å‚ç…§å…ˆã®é•ã„ã§å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚
ãã®å ´åˆã¯ã€æ¬¡ã®ã„ãšã‚Œã‹ã§å›é¿ã§ãã¾ã™ã€‚

```bash:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
# IDF_PATH ã®å½±éŸ¿ã‚’é¿ã‘ã¦ mix atomvm.esp32.flash ã‚’ä½¿ã†
env -u IDF_PATH mix atomvm.esp32.flash --port /dev/ttyACM0 --baud 115200
```

```bash:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
# esptool.py ã‚’ Python ã§ç›´æ¥å®Ÿè¡Œã™ã‚‹
python ~/esp/esp-idf/components/esptool_py/esptool/esptool.py \
  --chip esp32s3 \
  --port /dev/ttyACM0 \
  -b 115200 \
  --before default_reset \
  --after hard_reset \
  write_flash \
  --flash_mode keep \
  --flash_freq keep \
  --flash_size detect \
  0x250000 \
  sample_app.avm
```

## å‹•ä½œç¢ºèªï¼ˆãƒ­ã‚°ã‚’è¦‹ã‚‹ï¼‰

æ›¸ãè¾¼ã¿å¾Œã¯ã‚·ãƒªã‚¢ãƒ«ãƒ­ã‚°ã‚’è¦‹ã¦å‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚ESP-IDF ã®ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚’ä½¿ã†å ´åˆã¯ã“ã¡ã‚‰ã€‚

```bash:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
cd ~/Projects/atomvm/AtomVM/src/platforms/esp32
source ~/esp/esp-idf/export.sh

idf.py -p /dev/ttyACM0 monitor
# çµ‚äº†: Ctrl + ]
```

ESP-IDF ã‚’ä»‹ã•ãšã«è»½ãè¦‹ã‚‹ã ã‘ãªã‚‰ `picocom` ç­‰ã§ã‚‚ååˆ†ã§ã™ã€‚

```bash:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
picocom /dev/ttyACM0
# çµ‚äº†: Ctrl + a â†’ Ctrl + x
```

https://qiita.com/mnishiguchi/items/f8abd19f42ee287fb7ef

## ãŠã‚ã‚Šã«

AtomVM ã® ESP32 å‘ã‘ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã« C å´ã®æœ€å° NIF ã‚’çµ„ã¿è¾¼ã¿ã€Elixir ã‹ã‚‰å‘¼ã³å‡ºã™ã¨ã“ã‚ã¾ã§ã‚’æœ€å°æ§‹æˆã§ç¢ºèªã—ã¾ã—ãŸã€‚

ã“ã“ã¾ã§ã§ããŸã‚‰ã‚‚ã†ãªã‚“ã§ã‚‚ã§ãã‚‹ã¯ãšã€‚

![atomvm-hello-nif.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/82804/a38a3708-a8a6-4cc0-bc21-27a28fa2085a.png)


 ğŸŒ ğŸŒ ğŸŒ

https://piyopiyoex.connpass.com/event/377298/
