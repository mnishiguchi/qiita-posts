---
title: 'AtomVM 入門: Elixir で ESP32-S3 の LED を光らせる (2025年8月)'
tags:
  - Elixir
  - 組み込み
  - IoT
  - ESP32
  - AtomVM
private: false
updated_at: '2025-08-31T20:03:40+09:00'
id: 95c430d64301a884a8e0
organization_url_name: haw
slide: false
ignorePublish: false
---
## はじめに

以前からずっと氣になっていた [AtomVM] に挑戦してみました。

きっかけは、[IoT] に詳しい @kurokouji 氏との出会い。とある勉強会で [Elixir] や [Nerves] の話で盛り上がり、[AtomVM] の魅力を教えてもらいました。

なんと、[Seeed Studio XIAO ESP32-S3] も貸していただき、これはもう試すしかないという流れに。

ちょうど最近のカンファレンスでも [AtomVM] が話題になっていたところでした。参考までに以下のようなセッションも参考になりました。
* [The AtomVM and New Horizons for Elixir](https://youtu.be/ep--rQO1FRI)
* [La Machine: The Useless Box reloaded with Erlang and AtomVM](https://youtu.be/o-uCKdHz-wM)
* [Erlang and Elixir on IoT devices using AtomVM](https://youtu.be/m9hX9hzQ4F4)

少し前に、AtomVMの使いどころについて頭の整理をして軽くメモをまとめました。

https://qiita.com/mnishiguchi/items/69b3c3ddea99fd46705e

本記事では、[ESP32-S3] デバイス上で AtomVM をビルド・書き込みし、[Elixir] で書いた [Blinky] アプリケーションを動かすところまでの過程を記録します。

だれもがAIを使える時代です。

- 「AI があれば何でもできる。」
- 「元氣があれば何でもできる。」
- 「踏み出せば、その一足が道となる。」

そんな精神で迷わず手を動かしてみました。

この記事の内容は [SWEST27] の LT でも共有予定です。

![472968711-99ddc8ee-0178-474f-9212-b7df52bb31b5.gif](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/82804/729af366-0db7-4be2-8faa-b1a9cce5e7c1.gif)

![473267539-9099a053-fe35-45fd-9633-b75f7a760845.gif](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/82804/2786c885-5c2c-4720-851d-f362d4243c49.gif)

---

## 対象環境・機材

今回の開発環境・使用機材は以下の通りです。

### ハードウェア

- ボード: [Seeed Studio XIAO ESP32-S3]  
  ※オンボードLED（GPIO 21）が使えます。

### ホスト環境（開発用PC）

- Debian 系 Linux（LMDE6）
- [Elixir] 1.17（Erlang/OTP 27）
- [AtomVM] v0.6.6
- [ESP-IDF] v5.5（Espressif 公式SDK）
- [esptool] 5.0.1（Flash 書き込み用）

### 生成AI

- ChatGPT（`o4-mini-high`）を活用  

---

## まずは資料

[IoT]のことも、[ESP32]のことも、[AtomVM]のこともほとんど知らなかったので、まずは基本的な情報収集から始めました。

### 公式ドキュメント・リポジトリ

[AtomVM] は公式ドキュメントが充実していて、とても好印象でした。

- [公式サイト](https://doc.atomvm.org)  
  → インストール手順、ビルド方法、サンプルの使い方など
- [GitHub リポジトリ](https://github.com/atomvm/AtomVM)  
  → ソースコード本体と、ESP32向けファームウェアのビルド環境など
- [GitHub Releases](https://github.com/atomvm/AtomVM/releases)  
  → ビルド済みファームウェアや過去バージョンの情報もここから確認できます

### サンプルコード集

[AtomVM] には [Elixir] や [Erlang] で書かれたサンプルが複数あります。  
2025年8月時点では、以下の2つのリポジトリで若干異なるサンプルが管理されています。

- [atomvm/atomvm_examples](https://github.com/atomvm/atomvm_examples)  
- [atomvm/AtomVM/examples](https://github.com/atomvm/AtomVM/tree/main/examples)  

### バージョン依存情報

以下に、必要なソフトウェアのバージョン要件がまとまっています。  

- [Required Software — AtomVM Docs](https://doc.atomvm.org/latest/release-notes.html#required-software)

---

## AtomVM のインストール

今回の目的は、[ESP32-S3] デバイス上で [AtomVM] を動かし、[Elixir] で書いたコードを実行することです。

まずは公式が紹介している「ビルド済みイメージ」を試してみましたが、うまくいかず……。  
結局、ソースからビルドして書き込む方法で無事成功しました。

### ビルド済みイメージ（試したけど断念）

[公式 Getting Started ガイド][AtomVM/doc/getting-started] によると、[Releases ページ][AtomVM/releases] からビルド済みの AtomVM ファームウェアをダウンロードできるとのこと。

試してみましたが、うまく動かず…！
（何も理解していない段階だったので、どこが原因かも分からず。）

後日もう一度試したいですが、今回は潔くあきらめて、ソースコードからビルドする方針に切り替えました。

### ソースコードからビルド（こちらは成功）

[こちらの公式ドキュメント](https://doc.atomvm.org/latest/build-instructions.html#building-for-esp32) に従って、ESP32-S3 用ファームウェアを自分でビルドします。  

以下の3ステップで進めました：

1. ESP-IDF のインストール（ESP32-S3 向け）
2. AtomVM のソースコードを取得してビルド
3. ESP32-S3 用ファームウェアをビルド

#### ESP-IDF をインストール（ESP32-S3 向け）

[AtomVM] のビルドには、Espressif の公式 SDK である [ESP-IDF] が必要です。

参考リンク：

* [ESP-IDF Getting Started (ESP32-S3)](https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/get-started/)
* [ESP-IDF GitHub Releases](https://github.com/espressif/esp-idf/releases)

```bash
# 必要なツールをインストール
sudo apt install git wget flex bison gperf cmake ninja-build \
  ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

# esp-idfの保存場所は任意
mkdir -p $HOME/esp && cd $_

# ソース取得＆セットアップ
git clone --recursive https://github.com/espressif/esp-idf.git
cd esp-idf

# 安定版に切り替え
git checkout v5.5
git submodule update --init --recursive

# esp32s3 向けツール群をインストール
./install.sh esp32s3

# 現在のシェルに IDF 環境を読み込む
source ./export.sh
```

#### AtomVM をビルド（ホスト環境）

```bash
# AtomVMの保存場所は任意
mkdir -p $HOME/Projects/atomvm && cd $_

# ソースを取得
git clone https://github.com/atomvm/AtomVM.git
cd AtomVM

# 安定版に切り替え
git checkout v0.6.6

# ホスト環境向け VM のビルド
mkdir -p build && cd build
cmake ..
make -j$(nproc)
```

#### ESP32-S3 向けファームウェアをビルド

```bash
# ESP32用のAtomVMファームウェアをビルドするための CMake プロジェクトのルート
cd $HOME/Projects/atomvm/AtomVM/src/platforms/esp32

# 現在のシェルに IDF 環境を読み込む
source $HOME/esp/esp-idf/export.sh

# ターゲットを設定
idf.py set-target esp32s3

# 再構成とビルド
idf.py reconfigure
idf.py build
```

#### AtomVM を ESP32 に書き込み

前のファームウエアが残っていると不安定になることがあるので、ESP32デバイスから消去することが推奨されています。

```bash
esptool --chip auto --port /dev/ttyACM0 --baud 115200 erase-flash
```

以下のコマンドでESP32-S3 上に AtomVM を書き込みます。

```bash
cd $HOME/Projects/atomvm/AtomVM/src/platforms/esp32

# 現在のシェルに IDF 環境を読み込む
source $HOME/esp/esp-idf/export.sh

idf.py -p /dev/ttyACM0 flash
```

---

## Blinky を Elixir で作って実行する

AtomVM のビルドと書き込みが無事終わったら、いよいよ Elixir アプリケーション側を準備します。

最初の目標は、オンボードLED（GPIO 21）を 1秒ごとに点滅させる Blinky を作って動かすことです。

### サンプルコードを取得

AtomVM 公式の Elixir サンプル集から `Blinky` プロジェクトを取得します。

```bash
# サンプルプロジェクトの保存場所は任意
cd $HOME/Projects/atomvm

git clone https://github.com/atomvm/atomvm_examples.git

cd atomvm_examples/elixir/Blinky
```

依存ライブラリ（`ex_atomvm`）を取得：

```bash
mix deps.get
```

### GPIO ピン番号を変更（XIAO ESP32-S3 用）

Seeed Studio XIAO ESP32-S3 のオンボード LED は `GPIO 21` に接続されています。
デフォルトのサンプルは `GPIO 2` なので、以下のように修正します。

```elixir
defmodule Blinky do
  @pin 21

  def start() do
    :gpio.set_pin_mode(@pin, :output)
    loop(@pin, :low)
  end

  defp loop(pin, level) do
    :io.format(~c"Setting pin ~p ~p~n", [pin, level])
    :gpio.digital_write(pin, level)
    Process.sleep(1000)
    loop(pin, toggle(level))
  end

  defp toggle(:high), do: :low
  defp toggle(:low), do: :high
end
```

### AVM ファイルを生成

```bash
mix atomvm.packbeam
```

成功すると、以下のような `.avm` ファイルが生成されます。

```bash
ls -l *.avm
#=> -rw-r--r-- 1 user user  XXXX年XX月XX日 Blinky.avm
```

この `.avm` ファイルが、ESP32-S3 上で実行可能な AtomVM アプリケーションになります。

### アプリケーションの書き込み

以下のコマンドで、先ほど生成した `.avm` ファイルをESP32-S3 に転送します。

```bash
mix atomvm.esp32.flash --port /dev/ttyACM0 --baud 115200
```

これだけでアプリケーションの更新ができます。
AtomVM 本体は再書き込み不要です。`.avm` アプリケーションだけを何度でも差し替え可能です。

---

## シリアルログの確認

LED がチカチカするのと同時に、ログも出力されているはずです。

以下いずれかで確認できます。

### 方法1: `idf.py monitor`を使う

```bash
cd $HOME/Projects/atomvm/AtomVM/src/platforms/esp32

source $HOME/esp/esp-idf/export.sh

idf.py --port /dev/ttyACM0 monitor
```

* 終了方法：`Ctrl+]`

### 方法2: `picocom`等を使う

```bash
picocom /dev/ttyACM0 --baud 115200
```

* 終了方法：`Ctrl+A` → `Ctrl+X`

### どちらを使うべきか

`idf.py monitor` がログの内容が見やすくて個人的には好みです。
とはいえ、実行前に2つの準備作業が必要で、毎回はちょっと手間です。

1. ESP-IDF の環境をロードする必要がある（`source $HOME/esp/esp-idf/export.sh`）
2. AtomVMのESP32プロジェクトディレクトリ（`AtomVM/src/platforms/esp32`）に移動してから実行する必要がある

これらを毎回手作業でやるのはちょっと大変そうだったので、以下のような専用スクリプトを作って運用しています。

```text
$HOME/Projects/atomvm/scripts/esp32-monitor.sh
```

このスクリプトは、以下の処理を自動でやってくれます：

* ESP-IDF の `export.sh` を `source`
* AtomVM の ESP32 プラットフォームディレクトリへ `cd`
* `idf.py --port /dev/ttyACM0 monitor` を起動

---

## monitor用スクリプト紹介

AtomVM 関連のプロジェクトは `$HOME/Projects/atomvm/` 以下にまとめて管理しています。
そのため、各アプリケーションプロジェクトからは、以下のように一行でモニタを起動できます：

```bash
../scripts/esp32-monitor.sh
```

https://gist.github.com/mnishiguchi/e0810c4be07529506dd4fb33805cb2f9

## 開発サイクル

Elixirコード編集後はElixir アプリケーションを更新・転送するだけです。AtomVMファームの書き直しは不要です。

まるでスクリプトのような軽快さで、組み込み開発が楽しめます。

```bash
# .avm を再生成
mix atomvm.packbeam

# デバイスに再書き込み
mix atomvm.esp32.flash --port /dev/ttyACM0
```

---

## AIをどう活用したか？

AtomVMについて学ぶ際には、ChatGPT（`o4-mini-high`）を活用しました。特に助けられた場面は以下の通りです。

- Elixirでまだ未実装の関数
  → AtomVMに対応していない関数でも、Erlang 標準ライブラリや AtomVM API で代替できることが多い

- 似た処理をする C/C++ の既存ライブラリを AI に読ませる  
  → AtomVM 上で使えるように Elixir で書き直す際のヒントになった

- とはいえ、AIだけでは解決できない部分も多く、組込み経験のある仲間からの情報が突破口になる場面も

今回の学びは、AIの活用と、人との交流（コミュニティ）の両方があってこそ前に進めるということでした。

---

## おわりに

[AtomVM] を使うことで、[Elixir] や [Erlang] の強みを、リソース制限のある組み込みデバイス上でも活かせることがわかりました。

AIによるヒントと、経験豊富な仲間の一言が組み合わさることで、次の一手が見える瞬間が何度もありました。

今回の [Blinky] は最小構成の第一歩ですが、今後はより複雑なサンプルにもどんどん挑戦していきたいと思います。

![](https://github.com/user-attachments/assets/851da792-aef1-41b9-8931-4449079e4f6e)

image credit: [piyopiyo.ex](https://piyopiyoex.connpass.com) and [nako-san](https://connpass.com/user/ko-kudo)

https://github.com/mnishiguchi/hello_atomvm_tft_spi

https://piyopiyoex.connpass.com/event/362096/

---

[NervesJP]: https://nerves-jp.connpass.com/
[piyopiyo.ex]: https://piyopiyoex.connpass.com/
[autoracex]: https://autoracex.connpass.com/
[haw]: https://www.haw.co.jp/
[chaintope]: https://www.chaintope.com/
[IoT]: https://www.google.com/search?q=IoT%E3%81%A8%E3%81%AF
[AtomVM]: https://github.com/atomvm/AtomVM
[Elixir]: https://hexdocs.pm/elixir/introduction.html
[Nerves]: https://github.com/nerves-project
[SWEST27]: https://swest.toppers.jp/phx/
[Seeed Studio XIAO ESP32-S3]: https://wiki.seeedstudio.com/xiao_esp32s3_getting_started/
[ESP32]: https://www.google.com/search?q=ESP32%E3%81%A8%E3%81%AF
[ESP32-S3]: https://www.espressif.com/ja-jp/products/socs/esp32-s3
[AtomVM/releases]: https://github.com/atomvm/AtomVM/releases
[AtomVM/doc/getting-started]: https://doc.atomvm.org/latest/getting-started-guide.html#getting-started-on-the-esp32-platform
[Blinky]: https://github.com/atomvm/atomvm_examples/tree/master/elixir/Blinky
[Erlang]: https://www.erlang.org/doc/readme.html
[ESP-IDF]: https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/get-started/
[esptool]: https://docs.espressif.com/projects/esptool/en/latest/esp32/
